# Micronaut Hello World REST App with GraalVM Enterprise

This is a simple hello world REST application using the Micronaut framework and GraalVM Enterprise Native Image and JDK.

## Prerequisites

To run this sample on local (Mac OS), you need the following:

1. The latest GraalVM Enterprise 22.x for Java 17 components:
    - Native Image, and
    - JDK

2. (Optional) Maven. If you don't have Maven installed, you can use the Maven wrapper (`./mvnw`) included in the Micronaut code sample.

3. Check the versions installed using:

    ```shell
    $ echo $JAVA_HOME

    /Library/Java/JavaVirtualMachines/graalvm-ee-java17-22.1.0/Contents/Home
    ```

    ```shell
    $ echo $PATH

    /Library/Java/JavaVirtualMachines/graalvm-ee-java17-22.1.0/Contents/Home/bin:/usr/local/Cellar/maven/3.8.4/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin
   ```

    ```shell
    $ java -version
    
    java version "17.0.3" 2022-04-19 LTS
    Java(TM) SE Runtime Environment GraalVM EE 22.1.0 (build 17.0.3+8-LTS-jvmci-22.1-b05)
    Java HotSpot(TM) 64-Bit Server VM GraalVM EE 22.1.0 (build 17.0.3+8-LTS-jvmci-22.1-b05, mixed mode, sharing)
    ```

    ```shell
    $ native-image --version
    
    GraalVM 22.1.0 Java 17 EE (Java Version 17.0.3+8-LTS-jvmci-22.1-b05)
    ```

    ```shell
    $ mvn --version

    Apache Maven 3.8.4 (9b656c72d54e5bacbed989b64718c159fe39b537)
    Maven home: /usr/local/Cellar/maven/3.8.4/libexec
    Java version: 17.0.3, vendor: Oracle Corporation, runtime: /Library/Java/JavaVirtualMachines/graalvm-ee-java17-22.1.0/Contents/Home
    Default locale: en_US, platform encoding: UTF-8
    OS name: "mac os x", version: "12.4", arch: "x86_64", family: "mac"
    ```

    ```shell
    $ ./mvnw --version

    Apache Maven 3.6.3 (cecedd343002696d0abb50b32b541b8a6ba2883f)
    Maven home: /Users/graal/.m2/wrapper/dists/apache-maven-3.6.3-bin/1iopthnavndlasol9gbrbg6bf2/apache-maven-3.6.3
    Java version: 17.0.3, vendor: Oracle Corporation, runtime: /Library/Java/JavaVirtualMachines/graalvm-ee-java17-22.1.0/Contents/Home
    Default locale: en_US, platform encoding: UTF-8
    OS name: "mac os x", version: "12.4", arch: "x86_64", family: "mac"
    ```

## Steps
1. Git clone this repo.

2. Build the app JAR

    ```shell
    mvn package
    ```

    **OR** 

    ```shell
    ./mvnw package
    ```

3. Run the app JAR in the background

    ```shell
    java -jar target/MnHelloRest-0.1.jar &
    ```

4. Test the app JAR

    4.1) Should output "Hello World"

    ```shell
    curl http://localhost:8080/
    ```

    4.2) Should output "Hello Micronaut"

    ```shell
    curl http://localhost:8080/Micronaut
    ```

5. Bring the running app JAR in the foreground

    ```shell
    fg
    ```

6. Once the app is running in the foreground, press CTRL+C to stop it.

7. Build the app native executable

    ```shell
    mvn package -Dpackaging=native-image
    ```

    **OR** 

    ```shell
    ./mvnw package -Dpackaging=native-image
    ```

8. Run the app native executable in the background

    ```shell
    ./target/MnHelloRest &
    ```

9. Test the app native executable

    9.1) Should output "Hello World"

    ```shell
    curl http://localhost:8080/
    ```

    9.2) Should output "Hello Micronaut-Graal-Native"

    ```shell
    curl http://localhost:8080/Micronaut-Graal-Native
    ```

10. Bring the running app JAR in the foreground

    ```shell
    fg
    ```

11. Once the app is running in the foreground, press CTRL+C to stop it.


## Appendix 

### Learning from Micronaut-generated Dockerfiles

Let's use the Micronaut Maven plugin to generate a Dockerfile so we can learn how Micronaut uses multistage Docker builds to build the application as a native executable and package it in small runtime container images.

Micronaut uses GraalVM Community Edition as you will see in the `FROM ghcr.io/graalvm/...` statement in the generated Dockerfiles below.

#### Default option

Using this command we will see the default Dockerfile generated by Micronaut to build the native executable and package it in a small runtime image.

```shell
mvn mn:dockerfile -Dpackaging=docker-native
```

Here's the [generated default Dockerfile](/_reference/Dockerfile.generated-by-mn-default).

#### "Mostly static" option

Using this command we will see how Micronaut generates a “mostly static” native executable and packages it in a distroless base image.

```shell
mvn mn:dockerfile -Dpackaging=docker-native -Dmicronaut.native-image.base-image-run=gcr.io/distroless/base -Pgraalvm
```

Notice the `-H:+StaticExecutableWithDynamicLibC` in the [generated "mostly static" Dockerfile](/_reference/Dockerfile.generated-by-mn-mostly-static).